# Search API for Catalog Products

Проект реализует поиск по каталогу товаров (~1000 SKU) с упором на префиксные запросы. Он учитывает короткие запросы, транслитерацию, смешанные раскладки и числовые атрибуты (вес, объём, размер).  

---

## 1. Быстрый старт

Проект содержит Dockerfile и docker-compose для быстрого запуска OpenSearch и сервиса.

### Запуск через Docker Compose

```bash
# Собираем образ
docker-compose build

# Запускаем сервис и OpenSearch
docker-compose up
```

### Сервис будет доступен по адресу: http://localhost:8000/search.
### OpenSearch – на http://localhost:9200.


Конвертируйте XML в JSON и загружаем в индекс:
```bash
python scripts/xml_to_json.py
python scripts/load_catalog.py
```

Для проверки релевантности топ-результатов:
```bash
python scripts/evaluate.py 
```

### 2. Схема индекса и анализаторы

Используется OpenSearch индекс products с полями:

Поле	        Тип	        Анализатор
id	            keyword	    -
name	        text	    edge_ngram 1-15 + search_as_you_type
brand	        text	    edge_ngram 1-15
category	    keyword	    -
keywords	    text	    стандартный текстовый анализатор
description	    text	    стандартный текстовый анализатор
weight	        float	    -
package_size	float	    -
price	        float	    -
image_url	    keyword	    -

Логика ранжирования:

1. multi_match по name, brand и keywords.
2. Префиксный поиск через edge_ngram и match_bool_prefix.
3. Буcт по категории и бренду.
4. Фильтрация «мусорных» результатов: топ-результаты должны совпадать хотя бы по одному ключевому атрибуту (category или brand).
5. Обработка транслитерации и смешанных раскладок через utils.translit.

### 3. Сценарии пользователей

Основывались на prefix_queries.csv:

Персона	                        Примеры запросов	            Особенности
Mobile Shopper (Store D)    	ма, масло сл…	                Постепенное уточнение без «прыжков» между категориями
Premium Buyer (Store F)	        prosecco rose, riesling mosel	Латинские названия вин
B2B Buyer (Store C)	            масло раст 10л, cheddar 5kg	    Указание веса/литража
General Retail (Store E)	    xfq → чай	                    Ошибки раскладки, но релевантная категория

### 4. Снижение «мусора» в выдаче

1. Фильтрация по категории/бренду: отбрасываем документы, не соответствующие ожидаемым атрибутам.
2. Транслитерация: корректируем латиницу → кириллицу для совпадений.
3. Edge n-gram и match_bool_prefix: минимальные префиксы (1–3 символа) работают без сильных переписываний.
4. Порог score: документы с низким релевантностью не включаются в топ-результатов.
5. Логирование запросов: сохраняем исходный запрос и применённые нормализации для анализа ошибок.


### 5. Если бы это шло в прод

<h2>Мониторинг и алерты</h2>

- Health OpenSearch: отслеживание cluster_status и доступности нод.
- Латентность поиска: alert, если 95-й перцентиль > 1.5–2 с.
- Ошибки API: логирование и алерты при статусах ≠ 200.
- Обновление индекса: автоматические job’ы с валидацией новых SKU.

<h2>Дальнейшие улучшения</h2>

- Векторный/семантический поиск для длинных запросов и описаний.
- Prefix purity score – оценка качества префиксных результатов.
- Поведенческие бусты – учитываем клики, покупки для ранжирования.
- Механизм подсказок – prefix map с fallback’ом.
- Машинное обучение на reranker – улучшение топ-3 выдачи.
- Фильтрация B2B/розница – динамическая выдача в зависимости от типа пользователя.